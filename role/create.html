<!DOCTYPE html>
<html lang="en">

	<head>
		<meta charset="utf-8" />
		<title>Greeva - Responsive Bootstrap 4 Admin Dashboard</title>
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
		<meta content="A fully featured admin theme which can be used to build CRM, CMS, etc." name="description" />
		<meta content="Coderthemes" name="author" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge" />

		<!-- App favicon -->
		<link rel="shortcut icon" href="../assets/images/favicon.ico">

		<!-- Sweet Alert css -->
		<link href="../assets/libs/sweetalert2/sweetalert2.min.css" rel="stylesheet" type="text/css" />

		<!-- Icons css -->
		<link href="../assets/libs/@mdi/font/css/materialdesignicons.min.css" rel="stylesheet" type="text/css" />
		<link href="../assets/libs/dripicons/webfont/webfont.css" rel="stylesheet" type="text/css" />
		<link href="../assets/libs/simple-line-icons/css/simple-line-icons.css" rel="stylesheet" type="text/css" />

		<!-- App css -->
		<!-- build:css -->
		<link href="../assets/css/app.css" rel="stylesheet" type="text/css" />
		<!-- endbuild -->

	</head>

	<body>

		<!-- Navigation Bar-->
		<header id="topnav">
			<nav class="navbar-custom">

				<div class="container-fluid">
					<ul class="list-unstyled topbar-right-menu float-right mb-0">

						<li class="dropdown notification-list">
							<!-- Mobile menu toggle-->
							<a class="navbar-toggle nav-link">
								<div class="lines">
									<span></span>
									<span></span>
									<span></span>
								</div>
							</a>
							<!-- End mobile menu toggle-->
						</li>

						<li class="dropdown notification-list">
							<a class="nav-link dropdown-toggle arrow-none" data-toggle="dropdown" href="#" role="button" aria-haspopup="false" aria-expanded="false">
								<i class="dripicons-bell noti-icon"></i>
								<span class="badge badge-danger badge-pill noti-icon-badge">4</span>
							</a>
							<div class="dropdown-menu dropdown-menu-right dropdown-menu-animated dropdown-lg">

								<!-- item-->
								<div class="dropdown-item noti-title">
									<h5 class="m-0"><span class="float-right"><a href="" class="text-dark"><small>Clear All</small></a> </span>Notification</h5>
								</div>

								<div class="slimscroll noti-scroll">
									<!-- item-->
									<a href="javascript:void(0);" class="dropdown-item notify-item">
										<div class="notify-icon bg-warning"><i class="mdi mdi-comment-account-outline"></i></div>
										<p class="notify-details">Caleb Flakelar commented on Admin<small class="text-muted">1 min ago</small></p>
									</a>

									<!-- item-->
									<a href="javascript:void(0);" class="dropdown-item notify-item">
										<div class="notify-icon bg-info"><i class="mdi mdi-account-plus"></i></div>
										<p class="notify-details">New user registered.<small class="text-muted">5 hours ago</small></p>
									</a>

									<!-- item-->
									<a href="javascript:void(0);" class="dropdown-item notify-item">
										<div class="notify-icon"><img src="../assets/images/users/avatar-2.jpg" class="img-fluid rounded-circle" alt="" /> </div>
										<p class="notify-details">Cristina Pride</p>
										<p class="text-muted font-13 mb-0 user-msg">Hi, How are you? What about our next meeting</p>
									</a>

									<!-- item-->
									<a href="javascript:void(0);" class="dropdown-item notify-item">
										<div class="notify-icon bg-danger"><i class="mdi mdi-comment-account-outline"></i></div>
										<p class="notify-details">Caleb Flakelar commented on Admin<small class="text-muted">4 days ago</small></p>
									</a>

									<!-- item-->
									<a href="javascript:void(0);" class="dropdown-item notify-item">
										<div class="notify-icon"><img src="../assets/images/users/avatar-4.jpg" class="img-fluid rounded-circle" alt="" /> </div>
										<p class="notify-details">Karen Robinson</p>
										<p class="text-muted font-13 mb-0 user-msg">Wow that's great</p>
									</a>

									<!-- item-->
									<a href="javascript:void(0);" class="dropdown-item notify-item">
										<div class="notify-icon bg-primary"><i class="mdi mdi-heart"></i></div>
										<p class="notify-details">Carlos Crouch liked <b>Admin</b><small class="text-muted">13 days ago</small></p>
									</a>
								</div>

								<!-- All-->
								<a href="javascript:void(0);" class="dropdown-item text-center text-primary notify-item notify-all">
									View all <i class="fi-arrow-right"></i>
								</a>

							</div>
						</li>

						<li class="dropdown notification-list">
							<a class="nav-link dropdown-toggle nav-user" data-toggle="dropdown" href="#" role="button" aria-haspopup="false" aria-expanded="false">
								<span class="ml-1" id="userName" style="font-size: 26px;">AAAdmin<i class="mdi mdi-chevron-down"></i> </span>
							</a>
							<div class="dropdown-menu dropdown-menu-right dropdown-menu-animated profile-dropdown ">
								<!-- item-->
								<div class="dropdown-item noti-title">
									<h6 class="text-overflow m-0">欢迎 !</h6>
								</div>

								<!-- item-->
								<a href="javascript:void(0);" class="dropdown-item notify-item">
									<i class="dripicons-user"></i> <span>账号管理</span>
								</a>

								<!-- item-->
								<a href="javascript:void(0);" class="dropdown-item notify-item">
									<i class="dripicons-gear"></i> <span>个人设置</span>
								</a>

								<!-- item-->
								<a href="javascript:void(0);" class="dropdown-item notify-item">
									<i class="dripicons-lock"></i> <span>锁屏</span>
								</a>

								<!-- item-->
								<a href="javascript:void(0);" class="dropdown-item notify-item">
									<i class="dripicons-power"></i> <span>退出</span>
								</a>

							</div>
						</li>
						<li class="dropdown notification-list" style="margin-left: 10px;">
							<a href="javascript:void(0);" class="nav-link right-bar-toggle">
								<i class="mdi mdi-arrow-right-box mdi-24px"></i>
							</a>
						</li>

					</ul>

					<ul class="list-inline menu-left mb-0">
						<li class="float-left">
							<a href="#" class="logo">
								<span class="logo-lg" style="font-size: 30px;color: #05b4ac;">
                                	<!--一折通数据平台管理端-->
                                	农村业务部数据平台
                                    <!--<img src="../assets/images/logo.png" alt="" height="20">-->
                                </span>
								<span class="logo-sm">
                                    <img src="../assets/images/logo_sm.png" alt="" height="28">
                                </span>
							</a>
						</li>
						<li class="app-search">
							<form>
								<input type="text" placeholder="搜索..." class="form-control">
								<button type="submit" class="sr-only"></button>
							</form>
						</li>
					</ul>
				</div>
			</nav>
			<!-- end topbar-main -->

			<div class="topbar-menu">
				<div class="container-fluid">
					<div id="navigation">
						<!-- Navigation Menu-->
						<ul class="navigation-menu">

							<li class="has-submenu menu" id="departmentManagement" style="display: none;">
								<a href="#" id="department_link"><i class="mdi mdi-view-dashboard"></i>机构管理</a>
							</li>

							<li class="has-submenu menu active" id="roleManagement" style="display: none;">
								<a href="#" id="role_link"><i class="mdi mdi-atom"></i>角色管理</a>
							</li>

							<li class="has-submenu menu " id="staffManagement" style="display: none;">
								<a href="#" id="user_link"><i class="mdi mdi-email-outline"></i>用户管理</a>
							</li>

							<li class="has-submenu menu" id="permissionManagement" style="display: none;">
								<a href="#" id="permission_link"><i class="mdi mdi-cube-outline"></i>权限管理</a>
							</li>

							<li class="has-submenu menu" id="sourceManagement" style="display: none;">
								<a href="#" id="resource_link"><i class="mdi mdi-buffer"></i>资源管理</a>
							</li>

							<li class="has-submenu menu" id="systemManagement" style="display: none;">
								<a href="#" id="system_link"><i class="mdi mdi-file-multiple"></i>系统设置</a>
							</li>

						</ul>
						<!-- End navigation menu -->

						<div class="clearfix"></div>
					</div>
					<!-- end #navigation -->
				</div>
				<!-- end container -->
			</div>
			<!-- end navbar-custom -->
		</header>
		<!-- End Navigation Bar-->

		<div class="wrapper">
			<div class="container-fluid">

				<!-- Page title box -->
				<div class="page-title-alt-bg"></div>
				<div class="page-title-box">
					<ol class="breadcrumb float-right">
						<li class="breadcrumb-item">
							<a href="javascript:void(0);">Greeva</a>
						</li>
						<li class="breadcrumb-item">
							<a href="javascript:void(0);">Forms</a>
						</li>
						<li class="breadcrumb-item active">Form Elements</li>
					</ol>
					<h4 class="page-title">角色管理>创建<span id=""></span></h4>
				</div>
				<!-- End page title box -->
				<div class="row">
					<div class="col-md-12">
						<div class="card-box">
							<h4 class="m-t-0 header-title">创建角色</h4>
							<p class="text-muted m-b-30 font-13">
								创建一个角色并分配权限。
							</p>

							<div class="pull-in">
								<form id="xlfrom">
									<div id="example-vertical">

										<h3>角色信息</h3>
										<section>
											<div class="row">
												<label class="col-sm-2 col-form-label">角色名称：</label>
												<div class="col-sm-10">
													<input type="text" class="form-control" id="edRoleName">
												</div>
											</div>

											<div class="row" style="margin-top: 20px;">
												<label class="col-sm-2 col-form-label">角色描述：</label>
												<div class="col-sm-10">
													<textarea class="form-control" rows="5" id="edRoleDiscribe"></textarea>
												</div>
											</div>

											<div class="row" style="margin-top: 20px;">
												<label class="col-sm-2 col-form-label">机构状态</label>
												<div class="col-sm-10">
													<input type="text" id="edDptStatus" class="form-control" readonly="" value="正常">
												</div>
											</div>

											<!--<div class="form-group row">
												<label class="col-sm-2 col-form-label">Helping text</label>
												<div class="col-sm-10">
													<input type="text" class="form-control" placeholder="Helping text">
													<span class="help-block"><small>A block of help text that breaks onto a new line and may extend beyond one line.</small></span>
												</div>
											</div>-->

											<div class="form-group row" style="margin-top: 20px;">
												<label class="col-sm-2 col-form-label">父级角色：</label>
												<div class="col-sm-9">
													<select class="form-control" id="edParent">

													</select>
												</div>
											</div>

										</section>
										<h3>分配角色权限</h3>
										<section >
											<div class="row" id="permission">
												<!--<div class="col-sm-1">
													<label class="control-label">菜单权限:</label>
												</div>
												<div class="col-sm-11">
													<label class="checkbox-inline">
														<input type="checkbox" id="inlineCheckbox1" value="option1"> option1
													</label>
												</div>
										
												<div class="col-sm-1">
													<label class="control-label">操作权限:</label>
												</div>
												<div class="col-sm-11">
													<label class="checkbox-inline">
														<input type="checkbox" id="inlineCheckbox1" value="option1"> option1
													</label>
												</div>-->
											</div>
										</section>
									<h3>核对角色信息并创建</h3>
									<section>
										<div class="row">
											<div class="col-sm-2">
												<p><strong>角色名称：</strong></p>
			                                    <p><strong>角色描述：</strong></p>
			                                    <p><strong>父级角色：</strong></p>
			                                    <p><strong>角色权限：</strong></p>
											</div>
											<div class="col-sm-10">
												<p id="cname">惠水县和平镇</p>
			                                    <p id="cdiscription">张XX</p>
			                                    <p id="cparent">123</p>
			                                    <p id ="cpermission">123</p>
											</div>
										</div>
									</section>
									<!--<h3>会员等级</h3>
					<section>
						<h3>第四步，请根据实际情况自定义会员等级标准</h3>

					</section>-->
							</div>
							</form>
						</div>
						<!-- end .pull-in-->

					</div>
					<!-- end card-box -->
				</div>
				<!-- end col -->
			</div>

		</div>
		<!-- end container -->
		</div>
		<!-- end wrapper -->

		<!-- Footer -->
		<footer class="footer">
			<div class="container-fluid">
				<div class="row">
					<div class="col-12 text-center">
						2018 © Greeva. - 更多模板：
						<a href="http://www.mycodes.net/" target="_blank">源码之家</a>
					</div>
				</div>
			</div>
		</footer>
		<!-- End Footer -->

		<!-- /Right-bar -->

		<!-- jQuery  -->
		<script src="../assets/libs/jquery/jquery.min.js"></script>
		<script src="../assets/libs/bootstrap/js/bootstrap.bundle.min.js"></script>
		<script src="../assets/libs/jquery-slimscroll/jquery.slimscroll.min.js"></script>

		<!-- Sweet Alert Js  -->
		<script src="../assets/libs/sweetalert2/sweetalert2.min.js"></script>
		<script src="../assets/js/jquery.sweet-alert.init.js"></script>

		<!-- App js -->
		<script src="../assets/js/jquery.core.js"></script>
		<script src="../assets/js/jquery.app.js"></script>
		<script src="../assets/js/ictool.js" type="text/javascript" charset="utf-8"></script>

		<!--Form Wizard-->
		<script src="../assets/libs/jquery-steps/build/jquery.steps.min.js"></script>

		<!--wizard initialization-->
		<script src="../assets/js/jquery.wizard.js"></script>

		<script>
			var hid = null;
			var pid = null;
			var did = null;
			var currentRole = null;
			var url = localStorage.getItem("url");
			$(document).ready(function() {
				hid = getUrlParam('hid');
				pid = getCookie(hid);

				if(hid == null || pid == null) {
					window.location.href = "../jumplogin.html";
				}
				document.getElementById("department_link").href = "../index.html?hid=" + hid;;
				document.getElementById("role_link").href = "../role.html?hid=" + hid;
				$("#userName").text(sessionStorage.getItem(hid + 'name'));

				//console.log(pid);
				//				console.log(sessionStorage.getItem(hid + 'menus'));
				var departments = sessionStorage.getItem(hid + 'departments');
				var menus = JSON.parse(sessionStorage.getItem(hid + 'menus'));
				if(menus == null || menus == "" || menus.length == 0) {
					$.ajax({
						url: url + "home/getMenu",
						data: {
							sid: pid
						},
						type: "POST",
						dataType: 'json',
						success: function(data) {
							result = JSON.parse(data);
							if(result.status == 4) {
								window.location.href = "../jumplogin.html";
							}
							if(result.status == 6) {
								swalError("没有操作权限！");
								return;
							}
							console.log(JSON.stringify(data));

							menus = result.menu;
						},
						error: function(er) {
							console.log(JSON.stringify(er));
						}
					});
				}

				for(var i = 0; i < menus.length; i++) {　 //数组的遍历
					if(document.getElementById(menus[i])) {
						$("ul.navigation-menu li#" + menus[i]).show();
					}
				}

				$.ajax({
					url: url + "role/getChildren",
					data: {
						sid: pid
					},
					type: "POST",
					dataType: 'json',
					success: function(data) {
						//						alert(JSON.stringify(data));
						result = JSON.parse(data);
						if(result.status == 4) {
							window.location.href = "../jumplogin.html";
						}
						if(result.status == 6) {
							swalError("没有操作权限！");
							return;
						}
						var str = null;
						for(var s = 0; s < result.children.length; s++) {
							var stu = result.children[s];
							//							alert(stu); 
							str += '<option>' + stu + '</option>';
						}
						$("#edParent").html(str);
					},
					error: function(er) {
						console.log(JSON.stringify(er));
					}
				});

			});

			$("#submit").click(function() {
				alert("submit");
				var role = checkSumbit();
				alert("submit ajax");
				if(role == null)
					return;
				$.ajax({
					url: "http://localhost:8080/icdata/role/create",
					data: {
						sid: pid,
						role: JSON.stringify(role)
					},
					type: "POST",
					dataType: 'json',
					success: function(data) {
						var result = JSON.parse(data);
						if(result.status == 4) {
							window.location.href = "../jumplogin.html";
						}
						if(result.status == 7) {
							swalError("角色已存在！");
							return;
						}
						if(result.status == 6) {
							swalError("没有操作权限！");
							return;
						}
						//							updateLocalDepartments(updepartment);
						swal(
							'创建成功！',
							'你创建了一个角色！',
							'success'
						).then(function() {
							window.location.href = "../role.html?hid=" + hid;
						})
					},
					error: function(er) {
						console.log(JSON.stringify(er));
					}
				});
			});

			function checkSumbit() {
				alert("checkSumbit");
				var name = $("#edRoleName").val();
				var discription = $("#edRoleDiscribe").val();
				var parent = $("#edParent").find("option:selected").text();
				if(name == "") {
					swalError("角色名不能为空");
					return null;
				}
				if(discription == "") {
					swalError("角色描述不能为空");
					return null;
				}

				alert(name + discription + parent);
				var role = new Object();
				role.roleName = name;
				role.discription = discription;
				if(parent != "无")
					role.parent = parent;
				return role;
			}

			function updateLocalDepartments(updepartment) {
				$("#edDptName").val(updepartment.departmentName);
				$("#edDptsName").val(updepartment.departmentShortName);
				$("#edDptDiscribe").val(updepartment.departmentDescription);
				var departments = sessionStorage.getItem(hid + 'departments');
				var res = JSON.parse(departments);
				for(var s = 0; s < res.length; s++) {
					var stu = res[s];
					if(stu.departmentId == did) {
						res[s] = updepartment;
						break;
					}
					//					alert(stu.departmentName);
				}
				sessionStorage.setItem(hid + 'departments', JSON.stringify(res));
			}

			var role = new Object();
			let currentStepxl = 0;
			// 注册引导页
			$("#example-vertical").steps({
				headerTag: "h3", // 指定头部对应什么HTML标签
				bodyTag: "section", // 指定步骤内容对应的HTML标签
				//contentContainerTag:"div", // 指定包装所有内容的HTML标签
				//actionContainerTag:"div", // 指定包装分页导航的HTML标签
				//stepsContainerTag:"div", // 指定包装步骤内容的HTML标签
				stepsOrientation: 0, // 指定步骤为水平--vertical（垂直） horizontal（水平）
				transitionEffect: "slideLeft", // 步骤切换动画
				//autoFocus: true, // 将焦点设置为第一个向导实例，以便从一开始就启用关键导航 if true  优先级在startIndex之下
				//forceMoveForward: true, // 防止跳转到下一步
				//preloadContent: true,
				startIndex: currentStepxl, // 通过修改这个值来改变当前步数指向，即通过索引值确定向导加载后开始步骤是哪一步
				labels: {
					finish: "创  建", // 修改按钮得文本
					next: "下一步", // 下一步按钮的文本
					previous: "上一步", // 上一步按钮的文本
					loading: "Loading ..."
				},
				onStepChanging: function(event, currentIndex, newIndex) { // 下一步切换时的监听
					var result = false;

					if(currentIndex < newIndex && currentIndex == 0) { //第二步操作

						if(!checkMessege())
							return;
						rname = $("#edParent").find("option:selected").text();

						$.ajax({
							url: url + "role/getPermissions",
							data: {
								sid: pid,
								rname: rname
							},
							type: "POST",
							dataType: 'json',
							success: function(data) {
//								alert(JSON.stringify(data));
								result = JSON.parse(data);
								if(result.status == 4) {
									window.location.href = "../jumplogin.html";
								}
								if(result.status == 6) {
									swalError("没有操作权限！");
									return;
								}
								var str="<div class='col-sm-1'>"+
											"<label class='control-label'>菜单权限:</label>"+
										"</div>"+
									"<div class='col-sm-11'>";
								for(var s = 0; s < result.menus.length; s++) {
									var stu = result.menus[s];
									str+="<label class='checkbox-inline' style='padding-right: 20px;'>"+
											"<input type='checkbox' name='menu' id='inlineCheckbox1' value='"+stu+"'>"+stu+
										"</label>"
//																									alert(stu); 
									//									str += '<option>' + stu + '</option>';
								}
								str+="</div>"+
										"<div class='col-sm-1' style='margin-top: 20px;'>"+
											"<label class='control-label'>操作权限:</label>"+
										"</div>"+
									"<div class='col-sm-11' style='margin-top: 20px;'>";
								for(var s = 0; s < result.permissions.length; s++) {
									var stu = result.permissions[s];
									str+='<label class="checkbox-inline" style="padding-right: 20px;">'+
											'<input type="checkbox" name="permission" id="inlineCheckbox1" value="'+stu+'">'+ stu +
										'</label>'
//																									alert(stu); 
									//									str += '<option>' + stu + '</option>';
								}
								str+="</div>";
								$("#permission").html(str);
							},
							error: function(er) {
								console.log(JSON.stringify(er));
							}
						});
					}
					var cmenu='';
					var cpermission='';
					if(currentIndex < newIndex && currentIndex == 1) {
						$("input[name='menu']:checked").each(function(){cmenu+=this.value+','});
						$("input[name='permission']:checked").each(function(){cpermission+=this.value+','});
//						alert("2345:"+cmenu+","+cpermission);
						$("#cname").html($("#edRoleName").val());
						$("#cdiscription").html($("#edRoleDiscribe").val());
						$("#cparent").html($("#edParent").find("option:selected").text());
						$("#cpermission").html(cmenu+cpermission);
						role.roleName = $("#edRoleName").val();
						role.discription = $("#edRoleDiscribe").val();
						role.parent = $("#edParent").find("option:selected").text();
						role.menus = cmenu;
						role.permissions = cmenu+cpermission;
					}
					return true;
				},
				//        onStepChanged: function (event, currentIndex, priorIndex) {// 下一步切换完成得监听
				//
				//        },
				//        onCanceled: function (event) {// 取消按钮得监听
				//
				//        },
				onFinishing: function(event, currentIndex) { // 完成时得监听
					// form.validate().settings.ignore = ":disabled";
					$.ajax({
					url: "http://localhost:8080/icdata/role/create",
					data: {
						sid: pid,
						role: JSON.stringify(role)
					},
					type: "POST",
					dataType: 'json',
					success: function(data) {
						var result = JSON.parse(data);
						if(result.status == 4) {
							window.location.href = "../jumplogin.html";
						}
						if(result.status == 7) {
							swalError("角色已存在！");
							return;
						}
						if(result.status == 6) {
							swalError("没有操作权限！");
							return;
						}
						//							updateLocalDepartments(updepartment);
						swal(
							'创建成功！',
							'你创建了一个角色！',
							'success'
						).then(function() {
							window.location.href = "../role.html?hid=" + hid;
						})
					},
					error: function(er) {
						console.log(JSON.stringify(er));
					}
				});
					alert("完成时");
					return true;
				},
				onFinished: function(event, currentIndex) { // 完成后的监听
					//            parent.Index.judgeUserBinding();
					//            parent.addcustomer();// 打开新增会员等级页面
					alert("完成后");
					parent.layer.closeAll();

				}
			});

			function checkMessege() {
				var name = $("#edRoleName").val();
				var discription = $("#edRoleDiscribe").val();
				var parent = $("#edParent").find("option:selected").text();
				if(name == "") {
					swalError("角色名不能为空");
					return false;
				}
				if(discription == "") {
					swalError("角色描述不能为空");
					return false;
				}
				return true;
			}
		</script>

	</body>

</html>